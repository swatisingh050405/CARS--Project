{% extends "base.html" %}
{% block title %}Amendment Letter{% endblock %}

{% block content %}
<style>
    .form-label {
        font-weight: 600;
        margin-bottom: 2px;
    }
    .field-row {
        margin-bottom: 1.5rem;
    }
    .table thead th {
        background-color: #e3f2fd;
    }
    .table td, .table th {
        vertical-align: middle;
    }
    .table input, .table select {
        width: 100%;
        min-width: 80px;
        box-sizing: border-box;
    }
    input:read-only {
        font-weight: 600;
    }
    .is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.15rem #dc354580;
    }
    /* Remove excess card padding if needed */
    .card { padding: 2rem; }
</style>

<div class="container mt-4">
    <div class="card shadow-sm border-0">
        <h1 class="mb-4 text-center">Step 10: Amendment</h1>

        <form method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <!-- Top Row -->
            <div class="row g-2 field-row">
                <div class="col-md-4">
                    {{ form.amendment_no.label(class="form-label") }}
                    {{ form.amendment_no(class="form-control") }}
                </div>
                <br>
                <div class="col-md-4">
                    {{ form.amendment_date.label(class="form-label") }}
                    {{ form.amendment_date(class="form-control") }}
                </div>
                <br>
                <div class="col-md-4">
                    {{ form.project_duration.label(class="form-label") }}
                    {{ form.project_duration(class="form-control", id='project_duration', readonly=true) }}
                </div>
            </div>

            <div class="row g-2 field-row">
                <div class="col-md-4">
                    {{ form.pi.label(class="form-label") }}
                    {{ form.pi(class="form-control", readonly=true) }}
                </div>
                <br>
                <div class="col-md-4" id="co_pi_col">
                    {{ form.co_pi.label(class="form-label") }}
                    {{ form.co_pi(class="form-control") }}
                </div>
                <div class="col-md-4">
                    {{ form.institute.label(class="form-label") }}
                    {{ form.institute(class="form-control", readonly=true) }}
                </div>
            </div>

            <!-- PDF Upload -->
            <div class="mb-3">
                {{ form.amendment_pdf.label(class="form-label") }}
                {{ form.amendment_pdf(class="form-control") }}
                 {% if amendment and amendment.amendment_pdf %}
                    <small class="d-block mt-1">Already uploaded: 
                        <a href="{{ url_for('static', filename='uploads/' ~ amendment.amendment_pdf) }}" target="_blank">{{ amendment.amendment_pdf }}</a>
                    </small>
                {% endif %}
            </div>

            <!-- Revised Expenditures Table -->
            <h1 class="fw-bold mb-2">Revised Expenditures</h1>
            <table class="table table-striped table-hover table-bordered align-middle mb-2">
                <thead>
                    <tr><th>Head</th><th>Amount (₹)</th></tr>
                </thead>
                <tbody id="revExpTable">
                    {% for head in ['Personal','Equipment'] %}
                    <tr>
                        <td><input type="text" class="form-control fw-semibold" value="{{ head }}" readonly></td>
                        <td><input type="number" step="0.01" min="0" name="fixed_revised_{{ head|lower }}" value="{{ fixed_exp_amounts[head] }}" class="form-control cost-input"></td>
                    
                    </tr>
                    {% endfor %}
                    {% for entry in dynamic_exp %}
                    <tr>
                        <td><input type="text" name="dynamic_revised_head[]" value="{{ entry.head }}" class="form-control"></td>
                        <td><input type="number" step="0.01" min="0" name="dynamic_revised_amount[]" value="{{ entry.amount }}" class="form-control cost-input"></td>
                        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-x-circle"></i></button></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="text-end fw-bold">Total</td>
                        <td colspan="2"><input type="text" id="costTotal" class="form-control text-end fw-bold" readonly></td>
                    </tr>
                </tfoot>
            </table>
            <button type="button" id="addExpBtn" class="btn btn-outline-primary btn-sm mb-3">
                <i class="bi bi-plus-circle"></i> Add Expenditure Row
            </button>

            <!-- Schedule of Payment Table -->
            <h1 class="fw-bold mb-2">Schedule of Payment</h1>
            <table class="table table-striped table-hover table-bordered align-middle mb-2">
                <thead>
                    <tr><th>Milestone</th><th>Due Date</th><th>Amount (₹)</th></tr>
                </thead>
                <tbody id="sopTable">
                    {% for row in fixed_sop_rows %}
                    <tr>
                        <td><input type="text" class="form-control fw-semibold" value="{{ row.milestone }}" readonly></td>
                        <td><input type="date" name="fixed_due_date" value="{{ row.due_date }}" class="form-control"></td>
                        <td><input type="number" step="0.01" min="0" name="fixed_amount" value="{{ row.amount }}" class="form-control schedule-input"></td>
                      
                    </tr>
                    {% endfor %}
                    {% for entry in dynamic_sop_rows %}
                    <tr>
                        <td><input type="text" name="dynamic_sop_milestone[]" value="{{ entry.milestone }}" class="form-control"></td>
                        <td><input type="date" name="dynamic_sop_due[]" value="{{ entry.due_date }}" class="form-control"></td>
                        <td><input type="number" step="0.01" min="0" name="dynamic_sop_amount[]" value="{{ entry.amount }}" class="form-control schedule-input"></td>
                        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                            <i class="bi bi-x-circle"></i>
                        </button></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" class="text-end fw-bold">Total</td>
                        <td colspan="2"><input type="text" id="scheduleTotal" class="form-control text-end fw-bold" readonly></td>
                    </tr>
                </tfoot>
            </table>
            <button type="button" id="addSopBtn" class="btn btn-outline-primary btn-sm mb-3">
                <i class="bi bi-plus-circle"></i> Add Payment Row
            </button>
            <!-- Submit Button -->
             <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="submit" name="back" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back</button>
                <button type="submit" name="save" class="btn btn-success"><i class="bi bi-save"></i> Save</button>
                <button type="submit" name="next" class="btn btn-primary"><i class="bi bi-arrow-right"></i> Submit</button>
            </div>

        </form>
        
    </div>
</div>

<script>
function removeRow(btn) { btn.closest('tr').remove(); updateTotals(); }
document.getElementById('addExpBtn').addEventListener('click', () => {
    document.getElementById('revExpTable').insertAdjacentHTML('beforeend', `
        <tr>
            <td><input type="text" name="dynamic_revised_head[]" class="form-control"></td>
            <td><input type="number" step="0.01" min="0" name="dynamic_revised_amount[]" class="form-control cost-input"></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                <i class="bi bi-x-circle"></i></button></td>
        </tr>
    `);
});
document.getElementById('addSopBtn').addEventListener('click', () => {
    document.getElementById('sopTable').insertAdjacentHTML('beforeend', `
        <tr>
            <td><input type="text" name="dynamic_sop_milestone[]" class="form-control"></td>
            <td><input type="date" name="dynamic_sop_due[]" class="form-control"></td>
            <td><input type="number" step="0.01" min="0" name="dynamic_sop_amount[]" class="form-control schedule-input"></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">
                <i class="bi bi-x-circle"></i></button></td>
        </tr>
    `);
});
function updateTotals(){
    let costTotal = 0;
    document.querySelectorAll('.cost-input').forEach(inp=> costTotal += parseFloat(inp.value) || 0);
    document.getElementById('costTotal').value = costTotal.toFixed(2);

    let sopTotal = 0;
    document.querySelectorAll('.schedule-input').forEach(inp=> sopTotal += parseFloat(inp.value) || 0);
    document.getElementById('scheduleTotal').value = sopTotal.toFixed(2);
}
document.addEventListener('input', updateTotals);
updateTotals();

// Co-PI toggle
const coPiCol = document.getElementById('co_pi_col');
const durField = document.getElementById('project_duration');
function toggleCoPi(){
    if(parseInt(durField.value) >= 12){ coPiCol.style.display = 'block'; }
    else { coPiCol.style.display = 'none'; }
}
durField.addEventListener('input', toggleCoPi);
toggleCoPi();
</script>
{% endblock %}
