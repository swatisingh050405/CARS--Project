{% extends "base.html" %}
{% block title %}UO Number - Step 6{% endblock %}

{% block content %}
<style>
    .form-label {
        font-weight: 600;
        margin-bottom: 2px;
    }
    .field-row {
        margin-bottom: 1.5rem;
    }
    input:read-only {
        font-weight: 600;
    }
    .table thead th {
        background-color: #e3f2fd; /* light blue header */
    }
    .table-responsive {
        padding: 1rem 0.5rem;
        border-radius: .50rem;
    }
    .is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.15rem rgba(220,53,69,.15);
    }
    .table td, .table th {
        vertical-align: middle;
    }
    .table input, .table select {
        width: 100%; 
        min-width: 80px; 
        box-sizing: border-box;
    }
</style>

<div class="container mt-4">
    <div class="card p-4 shadow-sm border-0">
        <h1 class="mb-4 text-center">Step 6: UO Number</h1>
        <form method="POST">
            {{ form.hidden_tag() }}

            <div class="field-row row mb-4">
                <div class="col-md-4">
                    <label class="form-label">UO Number</label>
                    {{ form.uo_number(class="form-control", placeholder="Enter UO Number") }}
                </div>
            </div>

            <!-- UO Table -->
            <div class="table-responsive mb-3">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="uo-body">
                        {% for field_name in ['personal','equipment','travel','contingencies','visiting_faculty','technical_support','ipr_fees','overheads'] %}
                        <tr>
                            <td>{{ field_name.replace('_', ' ')|title }}</td>
                            <td>
                                <input type="number" step="0.01" name="{{ field_name }}"
                                       class="form-control amount-field"
                                       value="{{ form[field_name].data or '' }}">
                            </td>
                        </tr>
                        {% endfor %}

                        {% for entry in dynamic_entries %}
                        <tr class="dynamic-row">
                            <td>
                                <input type="text" name="dynamic_category" class="form-control" value="{{ entry.category }}">
                            </td>
                            <td>
                                <input type="number" step="0.01" name="dynamic_amount" class="form-control amount-field" value="{{ entry.amount }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="add-row">
                <i class="bi bi-plus-circle"></i> Add Row
            </button>
    
            <!-- GST and Total -->
            <div class="row field-row">
                <br>
                <div class="col-md-3">
                    <label class="form-label">GST (18%)</label>
                    <input type="number" step="0.01" name="gst" id="gst" class="form-control"
                           readonly value="{{ form.gst.data or '' }}">
                </div>
                <br>
                <div class="col-md-3">
                    <label class="form-label">Total Amount</label>
                    <input type="number" step="0.01" name="total_amount" id="total_amount" class="form-control"
                           readonly value="{{ form.total_amount.data or '' }}">
                </div>
            </div>

            <!-- Action Buttons (Right-Aligned) -->
           <div class="d-flex justify-content-end gap-2 mt-4">
                <button type="submit" name="back" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back</button>
                <button type="submit" name="save" class="btn btn-success"><i class="bi bi-save"></i> Save</button>
                <button type="submit" name="next" class="btn btn-primary"><i class="bi bi-arrow-right"></i> Next</button>
            </div>

        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function calculateTotals() {
        let total = 0;
        document.querySelectorAll(".amount-field").forEach(input => {
            const val = parseFloat(input.value);
            if (!isNaN(val)) total += val;
        });
        const gst = parseFloat((total * 0.18).toFixed(2));
        document.getElementById("gst").value = gst;
        document.getElementById("total_amount").value = (total + gst).toFixed(2);
    }

    document.getElementById("uo-body").addEventListener("input", calculateTotals);
    calculateTotals();

    document.getElementById("add-row").addEventListener("click", function () {
        const newRow = document.createElement("tr");
        newRow.classList.add("dynamic-row");
        newRow.innerHTML = `
            <td><input type="text" name="dynamic_category" class="form-control"></td>
            <td><input type="number" step="0.01" name="dynamic_amount" class="form-control amount-field"></td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row">✕</button></td>
        `;
        document.getElementById("uo-body").appendChild(newRow);
    });

    document.getElementById("uo-body").addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-row")) {
            e.target.closest("tr").remove();
            calculateTotals();
        }
    });
});
</script>
{% endblock %}
