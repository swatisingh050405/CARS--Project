{% extends "base.html" %}
{% block content %}
<style>
    .table thead th {
        background-color: #e3f2fd;
    }
    .form-label {
        font-weight: 600;
        margin-bottom: 4px;
    }
    .form-buttons {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 10px;
    }
    .status-dropdown.pending { background: #f8d7da; color: #842029; }
    .status-dropdown.completed { background: #d1e7dd; color: #0f5132; }
    .btn { min-width: 80px; }

    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    table.table input.form-control,
    table.table select.form-select {
        max-width: 100%;
        box-sizing: border-box;
    }
    table.table td, table.table th {
        white-space: nowrap;
        vertical-align: middle;
    }
    .card {
        overflow: hidden;
    }
</style>

<div class="card shadow rounded p-4">
    <div class="row align-items-start mb-3">
        <div class="col">
            <h1 class="mb-0"> Step 4: Summary Offer</h1>
        </div>
        <div class="col-auto">
            {% if overdue_milestones %}
            <div style="background-color: #f8d7da; color: #842029;
                        border-radius: 8px; padding: 10px 15px; min-width: 220px;
                        box-shadow: 0 0 2px #842029;">
                <h2 class="fw-bold mb-2">⚠ Overdue Milestones</h2>
                <ul class="mb-0 ps-3" style="font-size: 0.98em;">
                    {% for ms in overdue_milestones %}
                    <li>{{ ms.milestone }}
                        <medium>(Due: {{ ms.due_date.strftime('%d %b %Y') }})</medium>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <!-- Cost Entries Table -->
        <h1>Expected Expenditure</h1>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Head</th>
                        <th>Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="costTable">
                    {% set fixed_categories = ['Personal', 'Equipment', 'Other'] %}
                    {% for category in fixed_categories %}
                    <tr>
                        <td><input type="text" class="form-control" value="{{ category }}" readonly></td>
                        <td>
                            <input type="number" name="cost_{{ category.lower() }}" class="form-control cost-input"
                                   value="{% if existing_offer %}{{ (existing_offer.cost_entries | selectattr('category', 'equalto', category) | map(attribute='amount') | list | first) }}{% endif %}">
                        </td>
                    </tr>
                    {% endfor %}
                    {% if existing_offer %}
                        {% for entry in existing_offer.cost_entries %}
                            {% if entry.category not in fixed_categories and entry.category != "GST (18%)" %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="text" name="custom_cost_head[]" class="form-control" value="{{ entry.category }}">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); calculateCostTotals();">Delete</button>
                                    </div>
                                </td>
                                <td><input type="number" name="custom_cost_amount[]" class="form-control cost-input" value="{{ entry.amount }}"></td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr>
                        <td class="text-end fw-bold">GST (18%)</td>
                        <td><input type="text" id="costGST" class="form-control" readonly value="{% if existing_offer %}{{ existing_offer.gst_amount }}{% endif %}"></td>
                    </tr>
                    <tr>
                        <td class="text-end fw-bold">Total</td>
                        <td><input type="text" id="costTotal" class="form-control" readonly value="{% if existing_offer %}{{ existing_offer.total_amount }}{% endif %}"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addCostRow()">Add Cost Row</button>

        <!-- Milestone Table -->
        <h1 class="mt-4">Schedule of Payment</h1>
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Milestone</th>
                        <th>Due Date</th>
                        <th>Status</th>
                        <th>Amount (₹)</th>
                    </tr>
                </thead>
                <tbody id="milestoneTable">
                    {% for m in milestone_rows %}
                    <tr>
                        <td><input type="text" name="milestone_name[]" class="form-control" value="{{ m.milestone }}"></td>
                        <td><input type="date" name="milestone_date[]" class="form-control"
                                   value="{% if m.due_date %}{{ m.due_date.isoformat() }}{% endif %}"></td>
                        <td>
                            <select name="milestone_status[]" class="form-select status-dropdown" onchange="updateStatusColor(this)">
                                <option value="Pending" {% if m.status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="Completed" {% if m.status == 'Completed' %}selected{% endif %}>Completed</option>
                            </select>
                        </td>
                        <td><input type="number" name="milestone_amount[]" class="form-control milestone-input"
                                   value="{% if m.amount is not none %}{{ m.amount }}{% endif %}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Total</td>
                        <td><input type="text" id="milestoneTotal" class="form-control" readonly></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="addMilestoneRow()">Add Milestone</button>

        <!-- Upload PDF -->
        <div class="mb-3">
            <br>
            <label class="form-label"> Summary Offer PDF</label>
            {{ form.summary_pdf(class="form-control-file") }}
            {% if existing_offer and existing_offer.pdf_filename %}
                <p class="uploaded-file-link mt-2">
                    Already uploaded:
                    <a href="{{ url_for('static', filename='uploads/' ~ existing_offer.pdf_filename) }}" target="_blank">{{ existing_offer.pdf_filename }}</a>
                </p>
            {% endif %}
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="submit" name="back" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back</button>
            <button type="submit" name="save" class="btn btn-warning"><i class="bi bi-save"></i> Save</button>
            <button type="submit" name="next" class="btn btn-success"><i class="bi bi-arrow-right"></i> Next</button>
        </div>
    </form>
</div>

<!-- JavaScript -->
<script>
function calculateCostTotals() {
    let subtotal = 0;
    document.querySelectorAll('.cost-input').forEach(input => {
        const val = parseFloat(input.value) || 0;
        subtotal += val;
    });
    const gst = subtotal * 0.18;
    const total = subtotal + gst;
    document.getElementById('costGST').value = gst.toFixed(2);
    document.getElementById('costTotal').value = total.toFixed(2);
}

function calculateMilestoneTotal() {
    let total = 0;
    document.querySelectorAll('.milestone-input').forEach(input => {
        const val = parseFloat(input.value) || 0;
        total += val;
    });
    document.getElementById('milestoneTotal').value = total.toFixed(2);
}

function updateStatusColor(select) {
    select.classList.remove('pending', 'completed');
    if (select.value === 'Pending') select.classList.add('pending');
    else if (select.value === 'Completed') select.classList.add('completed');
}

function addCostRow() {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center gap-2">
                <input type="text" name="custom_cost_head[]" class="form-control" placeholder="Custom Head">
                <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); calculateCostTotals();">Delete</button>
            </div>
        </td>
        <td><input type="number" name="custom_cost_amount[]" class="form-control cost-input"></td>
    `;
    document.getElementById('costTable').appendChild(row);
}

function addMilestoneRow() {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center gap-2">
                <input type="text" name="milestone_name[]" class="form-control" placeholder="Custom Milestone">
                <button type="button" class="btn btn-sm btn-danger"
                        onclick="this.closest('tr').remove(); calculateMilestoneTotal();">Delete</button>
            </div>
        </td>
        <td><input type="date" name="milestone_date[]" class="form-control"></td>
        <td>
            <select name="milestone_status[]" class="form-select status-dropdown" onchange="updateStatusColor(this)">
                <option value="Pending" selected>Pending</option>
                <option value="Completed">Completed</option>
            </select>
        </td>
        <td><input type="number" name="milestone_amount[]" class="form-control milestone-input"></td>
    `;
    document.getElementById('milestoneTable').appendChild(row);
}

document.addEventListener('input', function () {
    calculateCostTotals();
    calculateMilestoneTotal();
});

document.addEventListener('DOMContentLoaded', function () {
    calculateCostTotals();
    calculateMilestoneTotal();
    document.querySelectorAll('.status-dropdown').forEach(updateStatusColor);
});
</script>
{% endblock %}
